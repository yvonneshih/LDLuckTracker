<script>
document.addEventListener("DOMContentLoaded", () => {
  let history = JSON.parse(localStorage.getItem("gachaHistory") || "[]");
  const table = document.getElementById("history");
  const charts = {};

  const addRow = (r) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.date}</td><td>${r.character}</td><td>${r.type}</td><td>${r.result}</td>
      <td>${r.eventCount || 0}</td><td>${r.normalCount || 0}</td><td>${r.tickets}</td><td>${r.memo}</td>`;
    table.appendChild(tr);
  };

  const updateVisuals = () => {
    updateLuckSummary();
    drawSummaryCharts();
  };

  const clearData = () => {
    if (confirm("Clear all data?")) {
      localStorage.removeItem("gachaHistory");
      history = [];
      table.innerHTML = "";
      updateVisuals();
    }
  };
  window.clearData = clearData;

  document.getElementById("gachaForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const record = {
      character: document.getElementById("character").value,
      type: document.getElementById("cardType").value,
      result: document.getElementById("resultType").value,
      eventCount: parseInt(document.getElementById("eventCount").value || 0),
      normalCount: parseInt(document.getElementById("normalCount").value || 0),
      tickets: parseInt(document.getElementById("tickets").value),
      date: document.getElementById("drawDate").value || "â€”",
      memo: document.getElementById("memo").value || "â€”"
    };
    history.push(record);
    localStorage.setItem("gachaHistory", JSON.stringify(history));
    addRow(record);
    updateVisuals();
    this.reset();
  });

  const updateLuckSummary = () => {
    let pity = 0;
    let totalEvent = 0;
    let luckRatings = [];
    for (let i = 0; i < history.length; i++) {
      const entry = history[i];
      pity += entry.tickets;
      if (entry.result === "event" && entry.eventCount > 0) {
        totalEvent += entry.eventCount;
        const avg = pity / entry.eventCount;
        let label =
          avg <= 30
            ? "ðŸŸ¢ Super Lucky"
            : avg <= 50
            ? "ðŸ’š Lucky"
            : avg < 70
            ? "âšª Average"
            : avg === 70
            ? "ðŸŸ  Pity"
            : "ðŸ”´ Unlucky";
        luckRatings.push(`${entry.date}: ${label} (${avg.toFixed(1)} pulls)`);
        pity = 0;
      } else if (entry.result === "normal" && entry.normalCount > 0) {
        // do nothing, continue pity
      }
    }
    const summaryDiv = document.getElementById("luckSummary");
    summaryDiv.innerHTML = `<h3>ðŸŽ¯ Luck Summary</h3>
      <p>Total Event 5â˜…: ${totalEvent}</p>
      <p>Ratings:</p>
      <ul>${luckRatings.map((l) => `<li>${l}</li>`).join("")}</ul>`;
  };

  const drawSummaryCharts = () => {
    const totalDraws = {}, eventCards = {}, luckByChar = {};
    for (const r of history) {
      if (!r.character) continue;
      totalDraws[r.character] = (totalDraws[r.character] || 0) + r.tickets;
      if (r.eventCount > 0) {
        eventCards[r.character] = (eventCards[r.character] || 0) + r.eventCount;
        luckByChar[r.character] = luckByChar[r.character] || { pulls: 0, count: 0 };
        luckByChar[r.character].pulls += r.tickets;
        luckByChar[r.character].count += r.eventCount;
      }
    }
    const format = (ctx, label, dataMap) =>
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(dataMap),
          datasets: [{
            label,
            data: Object.values(dataMap),
            backgroundColor: ["#f77", "#7cf", "#fc7", "#a7f", "#6e6", "#aaa", "#ccc"]
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

    const avgLuck = {};
    for (const c in luckByChar) {
      avgLuck[c] = (luckByChar[c].pulls / luckByChar[c].count).toFixed(1);
    }

    if (charts.totalDrawsChart) charts.totalDrawsChart.destroy();
    if (charts.luckPerEventChart) charts.luckPerEventChart.destroy();
    if (charts.eventCardsChart) charts.eventCardsChart.destroy();

    charts.totalDrawsChart = format(document.getElementById("totalDrawsChart"), "Total Draws", totalDraws);
    charts.luckPerEventChart = format(document.getElementById("luckPerEventChart"), "Avg Pulls per Event 5â˜…", avgLuck);
    charts.eventCardsChart = format(document.getElementById("eventCardsChart"), "Total Event 5â˜… Cards", eventCards);
  };

  history.forEach(addRow);
  updateVisuals();
});
</script>
